{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
  <h2>üì§ Upload Your Dataset</h2>
  <p class="text-muted">Supported formats: CSV, Excel (.xlsx), and SAS7BDAT</p>

  <div id="upload-area" class="border border-3 rounded p-5 text-center bg-light" style="border-style: dashed;">
    <p class="fs-5">Drag & drop your file here or</p>
    <input type="file" id="fileInput" class="form-control w-50 mx-auto" accept=".csv,.xlsx,.sas7bdat">
    <button class="btn btn-primary mt-3" id="uploadBtn">üìÇ Upload File</button>
  </div>

  <div id="uploadStatus" class="mt-4"></div>

  <div id="previewArea" class="mt-4">
    <div class="table-responsive" style="max-height: 400px; overflow: auto;"></div>
  </div>

  <div id="nextStep" class="mt-4" style="display: none;">
    <div class="d-flex gap-3 flex-wrap">
      <a href="/" class="btn btn-outline-secondary">
        ‚¨ÖÔ∏è Back to Home
      </a>
      <a href="/columns" class="btn btn-success">
        ‚û°Ô∏è Continue to Column Selection
      </a>
    </div>
  </div>
</div>

<script>
document.getElementById("uploadBtn").addEventListener("click", function () {
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];

  if (!file) {
    alert("Please select a file first.");
    return;
  }

  const allowedTypes = ['text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/x-sas-data'];
  if (!allowedTypes.includes(file.type) && !file.name.endsWith('.sas7bdat')) {
    alert("Unsupported file format.");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  document.getElementById("uploadStatus").innerHTML = "<div class='spinner-border text-primary' role='status'></div> Uploading...";
  document.getElementById("nextStep").style.display = "none";
  document.querySelector("#previewArea .table-responsive").innerHTML = "";

  fetch("/upload_ajax", {
    method: "POST",
    body: formData,
  })
    .then(response => response.json())
    .then(data => {
      if (data.preview_html) {
        document.getElementById("uploadStatus").innerHTML = "<div class='alert alert-success'>‚úÖ Upload successful!</div>";
        document.querySelector("#previewArea .table-responsive").innerHTML = data.preview_html;
        document.getElementById("nextStep").style.display = "block";
      } else {
        document.getElementById("uploadStatus").innerHTML = "<div class='alert alert-danger'>‚ùå " + (data.error || "Upload failed.") + "</div>";
      }
    })
    .catch(error => {
      document.getElementById("uploadStatus").innerHTML = "<div class='alert alert-danger'>‚ùå Upload failed.</div>";
    });
});
</script>
{% endblock %}